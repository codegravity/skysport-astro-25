---
export const prerender = false;  // not needed in server mode
import NewsModal from '../modals/newsletter.astro'




---
<div class="form-container relative z-0">
  <form method="POST" class="flex flex-col space-y-2" > 
   
      <input required id="hs-email-nyhetsbrev" name="hs-email-nyhetsbrev" type="email" autocomplete="email" placeholder="E-post"
          class="px-4 py-2 bg-slate-800 border border-slate-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-orange-500"
      />
       
      <button id="newsSubmit" type="submit" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg font-semibold transition-colors" >
          Prenumerera
      </button>
  </form>
   <div id="result" class="mt-3  text-slate-100 text-center"></div>
  <div id="successMessage" class="hidden absolute inset-0 bg-gray-200 flex justify-center items-center z-10 text-green-800 text-xl px-6 text-semibold rounded-lg"> Toppen ! Din anmälning är skickad till oss.</div>
</div>
<NewsModal />


<script is:inline>

  const displaySuccessMessage = () => {
    document.getElementById("successMessage").classList.remove("hidden");
  }

  const get = (id) => document.getElementById(id) || { value: '' }  // this creates instance of get for entire site!!

  const submitNewsForm = () => {
    //sendNewsmail()
    validateNews()
   // alert('Tack! Din anmälan är skickad.')
    element.open();
  }

const validateNews = () => {

  if (get('hs-email-nyhetsbrev').value.length < 5 || !get('hs-email-nyhetsbrev').value.includes('@')) {
      HSOverlay.open('#hs-danger-news-alert');
      get('hs-email-nyhetsbrev').classList.remove('border-gray-200')
      get('hs-email-nyhetsbrev').classList.add('border-red-500')
      get('hs-email-nyhetsbrev').focus();
    } else {
      HSOverlay.open('#hs-task-newsletter-alert'); // not working as page reloads after sending...
      sendNewsmail()
      displaySuccessMessage()
    }

  }

  const getNewsFormData = () => {
    const store = Object.create(null)
    store.email = get('hs-email-nyhetsbrev')?.value
    store.subject = 'Skysports Nyhetsbrev'  
    return store
  }

  const result = document.getElementById("result");
  //const submitNewsBtn = document.querySelector('[type="submit"]')

  const submitNewsBtn = document.getElementById('newsSubmit')
  submitNewsBtn?.addEventListener('click', submitNewsForm)

  const sendNewsmail = async () => {
    //console.log('sending email step 1')
    //alert('getting form data?')
    const {  email, subject } = getNewsFormData()
      
    const data = await fetch('/api/sendAnmalanNyhetsBrev.json', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ email, subject }),
    })
      .then((res) => {
        if (!res.ok) {
         result.innerHTML = "Sending xxx..."; // this is shown if error occurs
          throw new Error(res.status)
        }
 if (res.status == 200) {
  
              result.classList.add("text-green-500");
              result.innerHTML = 'it worked!';
              res.redirect('/OmOss/integritetspolicy');
              
            }
        //alert('Anmälan skickad !' + res.status ) //works if next line has commented out
       
        //return res.json()
      })
      .catch((err) => {
        console.log('Error', err)
        throw new Error('Network error.')
      })
       //return redirect('/OmOss/integritetspolicy');
   // console.log(data) // Here is the response from backend

   //alert('Message successfully sent' + data); // works
   
   //return data;
    
   // document.getElementById("successMessage").classList.remove("hidden");
  }

</script>




